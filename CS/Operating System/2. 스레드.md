# 스레드

### 1. 스레드  정의

* 프로세스 내에서 실행되는 여러 흐름의 단위. CPU 이용의 기본 단위.

<br/>

### 2. 스레드 특징

* 스레드는 프로세스의 자원을 공유한다.
* 프로세스 내에서 각각 Stack만 따로 할당받고, text(code), data, heap 영역은 공유한다.
* 장점
  * CPU 활용도 높인다.
  * 응답성 향상시킨다
  * 자원과 메모리 공유 가능하다.
  * 공유 주소공간 사용으로 별도의 통신기법 필요 없다.

* 단점
  * 여러 스레드 생성 시 성능 저하 가능하다.
  * 하나의 스레드에서 문제가 발생하면 프로세스 전반에 영향을 끼칠 수 있다.


<br/>

### 3. 스레드 개수에 따른 프로세스

* 중량 프로세스 : 단일 스레드 가진 프로세스

* 경량 프로세스 : 하나의 프로세스가 다수의 스레드를 가진 프로세스(멀티,다중 스레드). 동시에 여러 작업 수행한다.


<br/>

### 4. 스레드 종류

- 사용자 수준 스레드(User-Level Thread)
  - 다대일 스레드 매핑 : 다수의 사용자 수준 스레드가 커널 수준 스레드 한개에 매핑.
  - 커널의 개입을 받지 않는다.
  - 장점
    - 사용자 영역에서의 생성 및 관리로 속도 빠르다.
    - 커널 개입 받지 않아 이식성이 높다.
  - 단점
    - 커널에서 하나의 스레드로 판단하여 중단되면 나머지 모든 스레드 중단된다.
- 커널 수준 스레드 (Kernel-Level Thread)
  - OS가 지원하는 스레드 기능으로 구현, 커널이 스레드 생성 및 스케줄링 관리한다.
  - 일대일 매핑 : 사용자 수준 스레드 생성하면 커널 스레드 자동 생성된다.
  - 장점
    - 프로세스 내 스레드 병행 수행 가능하다
  - 단점
    - 사용자 스레드보다 생성 및 관리 속도 느리다.
- 혼합 스레드
  - 사용자 수준 스레드 + 커널 수준 스레드
  - 다대다 매핑 : 다수의 사용자 수준 스레드와 다수의 커널 스레드가 매핑된다.
  - 장점
    - 병행 수행 가능하다
    - 스레드 풀링 기법을 통해 일대일 스레드 매핑에서의 오버헤드 줄인다.

### 5. 스레드 풀링

* 스레드의 풀을 제공해 미리 생성한 스레드를 재사용하도록 도와주고 스레드 생성 시간을 줄여 시스템의 부담을 덜어준다. 동시 생성 스레드 수 제한해 시스템의 자원 소비를 줄인다.


<br/>

### 6. 스레드 제어 블로 TCB

- 프로그램 카운터(PC) 값 : 다음에 실행할 명령어의 주소 - 멀티 스레드 환경
- CPU 레지스터의 값 : CPU 연산을 위해 현재 레지스터의 저장 값을 나타냄 - 멀티 스레드 환경

<br/>

### 7. 멀티 스레드

* 하나의 프로그램에 여러 개의 스레드로 구성하고 각 스레드마다 하나의 작업을 처리하도록 하는 것이다.
* 대표적인 멀티 스레드 응용 프로그램 : 웹 서버
* 장점
  * 시스템 자원 소모 감소(프로세스 생성해 자원 할당하는 콜이 줄어 효율적으로 관리 가능)
  * 시스템 처리 비용 감소(스레드 간 통신 간단해져 자원 소모 줄고 작업량이 작아 context switching 빨라진다.)
  * 프로그램 응답 시간 단축(stack을 제외한 모든 메모리 공유로 통신 부담이 적다)

* 단점
  * 단일 프로세스 시스템은 효과 기대하기 어렵다
  * 자원 공유의 문제 발생 가능(동기화 문제 : 스레드간 자원 공유는 전역변수를 이용해 충돌 발생 가능하다)
  * 하나의 스레드에 문제 발생하면 전체 프로세스가 영향을 받는다


<br/>

### 8. 동기화 이슈

- 작업들 사이에 실행시기를 맞추는 것
- 여러 스레드가 동일한 자원(데이터) 접근시 동기화 이슈 발생(동일 자원을 여러 스레드가 동시에 수정시 영향)
- 해결방안 : 한 스레드가 공유 변수를 갱신하는 동아 다른 스레드의 접근을 막기 위해 임계구역에 Locking 메커니즘 적용

<Locking 메커니즘>

1. Mutex(binary semaphore): 임계구역에 하나의 스레드만 들어감
2. Semaphore: 임계구역에 허용한 스레드 수만큼 접근 가능

<br/>

### 9. 그 외 이슈

### 교착상태(데드락)

- **무한 대기 상태**: 두 개 이상 작업이 서로 상대방 작업이 끝나기를 기다리며 진행하지 못하는 상태
    
    
- **발생 조건**
    
    네 가지 조건이 모두 성립
    
    1. 상호배제(Mutual exclusion): 프로세스들이 필요로 하는 자원에 대해 배타적인 통제권을 요구한다.
    2. 점유대기(Hold and wait): 프로세스가 할당된 자원을 가진 상태에서 다른 자원을 기다린다.
    3. 비선점(No preemption): 프로세스가 어떤 자원의 사용을 끝낼 때까지 그 자원을 뺏을 수 없다.
    4. 순환대기(Circular wait): 각 프로세스는 순환적으로 다음 프로세스가 요구하는 자원을 가지고 있다
- **해결 방법**
    1. 교착상태 예방
    : 4가지 발생 조건 중 하나를 제거하는 방법
    2. 교착상태 회피
    : 교착상태 조건 중, 자원 할당 순서를 정의하지 않음(순환 대기 조건 제거)
    3. 교착상태 발견
    : 교착 상태를 일으킨 프로세스를 종료하거나 교착상태의 프로세스에 할당된 자원을 선점하여 프로세스나 자원을 회복하는 것
    4. 교착상태 회복
    : 교착 상태를 일으킨 프로세스를 종료하거나 교착상태의 프로세스에 할당된 자원을 선점하여 프로세스나 자원을 회복하는 것



